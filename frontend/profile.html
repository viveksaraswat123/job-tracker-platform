<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Profile â€¢ Job Tracker</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  .profile-header { background-color: #343a40; color: white; padding: 60px 0; position: relative; }
  .avatar-container { position: absolute; bottom: -50px; left: 50%; transform: translateX(-50%); }
  .avatar { width: 100px; height: 100px; border: 4px solid white; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
</style>
</head>

<body>

<!-- Profile Header -->
<section class="profile-header">
  <div class="container text-center">
    <div class="avatar-container">
      <img id="avatar-img" src="/static/default-avatar.png" class="avatar rounded-circle" style="object-fit: cover;">
      <input type="file" id="avatar" accept="image/*" class="d-none" onchange="uploadAvatar()">
      <button onclick="document.getElementById('avatar').click()" class="btn btn-light btn-sm position-absolute" style="bottom: 5px; right: 5px;">Change</button>
    </div>
  </div>
</section>

<div class="container mt-5 pt-4">
  <div class="row">
    <div class="col-md-8 mx-auto">
      <h2 id="user-name" class="text-center mb-2">Loading...</h2>
      <p id="user-email" class="text-center text-muted mb-4">---</p>

      <!-- Stats -->
      <div class="row text-center mb-4">
        <div class="col-6 col-md-3">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title text-primary">Applied</h5>
              <h3 id="stat-applied">0</h3>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title text-warning">Interview</h5>
              <h3 id="stat-interview">0</h3>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title text-danger">Rejected</h5>
              <h3 id="stat-rejected">0</h3>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title text-success">Offers</h5>
              <h3 id="stat-offer">0</h3>
            </div>
          </div>
        </div>
      </div>

      <!-- Profile Form -->
      <div class="card">
        <div class="card-body">
          <h3 class="card-title mb-4">Personal Information</h3>
          <form id="profile-form">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Full Name</label>
                <input type="text" id="name" class="form-control">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Phone</label>
                <input type="tel" id="phone" class="form-control">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Skills</label>
              <input type="text" id="skills" class="form-control" placeholder="e.g. Python, React, SQL">
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Location</label>
                <input type="text" id="location" class="form-control">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Resume</label>
                <input type="file" id="resume" accept=".pdf,.doc,.docx" class="form-control">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">LinkedIn</label>
                <input type="url" id="linkedin" class="form-control">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">GitHub</label>
                <input type="url" id="github" class="form-control">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Portfolio</label>
              <input type="url" id="portfolio" class="form-control">
            </div>
            <button type="button" onclick="saveProfile()" class="btn btn-primary">Save Changes</button>
            <div id="save-msg" class="mt-3"></div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const token = localStorage.getItem("token");

window.onload = () => { loadProfile(); loadStats(); };

async function loadProfile(){
  const res = await fetch("/auth/me", { headers:{ "Authorization":"Bearer "+token }});
  const u = await res.json();

  document.getElementById("user-name").innerText = u.name || "Add Your Name";
  document.getElementById("user-email").innerText = u.email;
  document.getElementById("avatar-img").src = u.avatar || "/static/default-avatar.png";
  document.getElementById("name").value = u.name || "";
  document.getElementById("phone").value = u.phone || "";
  document.getElementById("skills").value = u.skills || "";
  document.getElementById("location").value = u.location || "";
  document.getElementById("linkedin").value = u.linkedin || "";
  document.getElementById("github").value = u.github || "";
  document.getElementById("portfolio").value = u.portfolio || "";
}

async function loadStats(){
  const res = await fetch("/auth/profile/stats", { headers:{ "Authorization":"Bearer "+token }});
  const s = await res.json();
  document.getElementById("stat-applied").innerText = s.applied;
  document.getElementById("stat-interview").innerText = s.interview;
  document.getElementById("stat-rejected").innerText = s.rejected;
  document.getElementById("stat-offer").innerText = s.offers;
}

async function saveProfile(){
  const data = {
    name: document.getElementById("name").value,
    phone: document.getElementById("phone").value,
    skills: document.getElementById("skills").value,
    location: document.getElementById("location").value,
    linkedin: document.getElementById("linkedin").value,
    github: document.getElementById("github").value,
    portfolio: document.getElementById("portfolio").value
  };

  const res = await fetch("/auth/profile/update", {
    method: "PUT",
    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
    body: JSON.stringify(data)
  });

  const msg = document.getElementById("save-msg");
  if(res.ok){
    msg.innerHTML = '<div class="alert alert-success">Profile updated successfully!</div>';
  } else {
    msg.innerHTML = '<div class="alert alert-danger">Error updating profile</div>';
  }
  setTimeout(() => msg.innerHTML = "", 3000);
}

async function uploadAvatar(){
  const file = document.getElementById("avatar").files[0];
  if(!file) return;

  const formData = new FormData();
  formData.append("file", file);

  const res = await fetch("/auth/profile/avatar", {
    method: "POST",
    headers: { "Authorization": "Bearer " + token },
    body: formData
  });

  if(res.ok){
    const data = await res.json();
    document.getElementById("avatar-img").src = data.avatar;
  }
}

async function uploadResume(){
  const file = document.getElementById("resume").files[0];
  if(!file) return;

  const formData = new FormData();
  formData.append("file", file);

  const res = await fetch("/auth/profile/resume", {
    method: "POST",
    headers: { "Authorization": "Bearer " + token },
    body: formData
  });

  if(res.ok){
    alert("Resume uploaded successfully!");
  }
}
</script>
  document.getElementById("resume-link").href = u.resume || "#";

  loadStats();
  loadTimeline();
}

async function loadStats(){
  const res = await fetch("/auth/profile/stats", { headers:{ "Authorization":"Bearer "+token }});
  const s = await res.json();
  document.getElementById("stat-applied").innerText = s.applied;
  document.getElementById("stat-interview").innerText = s.interview;
  document.getElementById("stat-rejected").innerText = s.rejected;
  document.getElementById("stat-offer").innerText = s.offers;
}

async function loadTimeline(){
  const res = await fetch("/auth/profile/timeline", { headers:{ "Authorization":"Bearer "+token }});
  const list = await res.json();
  const box = document.getElementById("timeline");
  box.innerHTML="";
  list.forEach(a=>{
    box.innerHTML += `<div class="bg-white p-3 rounded-xl shadow text-xs">${a}</div>`;
  });
}

async function updateProfile(){
  const payload = {
    name: document.getElementById("name").value,
    phone: document.getElementById("phone").value,
    skills: document.getElementById("skills").value,
    location: document.getElementById("location").value,
    linkedin: document.getElementById("linkedin").value,
    github: document.getElementById("github").value,
    portfolio: document.getElementById("portfolio").value
  };

  const res = await fetch("/auth/profile/update", {
    method:"PUT",
    headers:{ "Content-Type":"application/json","Authorization":"Bearer "+token },
    body: JSON.stringify(payload)
  });

  const d = await res.json();
  document.getElementById("msg").innerText = d.message;
}

async function uploadAvatar(){
  const file = document.getElementById("avatar").files[0];
  const form = new FormData();
  form.append("file", file);

  const res = await fetch("/auth/profile/avatar", { method:"POST", headers:{ "Authorization":"Bearer "+token }, body:form });
  const d = await res.json();
  document.getElementById("msg").innerText = d.message;
}

async function uploadResume(){
  const file = document.getElementById("resume").files[0];
  const form = new FormData();
  form.append("file", file);

  const res = await fetch("/auth/profile/resume", { method:"POST", headers:{ "Authorization":"Bearer "+token }, body:form });
  const d = await res.json();
  document.getElementById("msg").innerText = d.message;
}

gsap.from("section, nav, .bg-white", {y:30,opacity:0,duration:0.6,stagger:0.2});
loadProfile();
</script>

</body>
</html>
